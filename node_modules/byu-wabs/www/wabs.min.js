!function(appName,reservedPath){"use strict";var accessTokenTimeoutId,prevCookieString,originalBrownie,EVENT_PREFIX="byu-browser-oauth",EVENT_STATE_CHANGE=EVENT_PREFIX+"-state-changed",isCFrameworkRx=/^https?:\/\/y(?:-[a-z]*)?\.byu.edu\/(?:[\s\S]*?)\.cgi[\/\?]?/i,authCookieName="wabs-"+appName,prevAuthState={oauth:!1,user:!1},win=window,doc=document,session=win.sessionStorage;if(!win.byu||!win.byu.brownie){var byu=win.byu||{};byu.auth||(byu.auth={}),byu.brownie||(byu.brownie={}),win.byu=byu,function(){if("function"==typeof win.CustomEvent)return;function CustomEvent(event,params){params=params||{bubbles:!1,cancelable:!1,detail:void 0};var evt=doc.createEvent("CustomEvent");return evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail),evt}CustomEvent.prototype=win.Event.prototype,win.CustomEvent=CustomEvent}(),byu.ajax||(byu.ajax=ajax),Object.defineProperties(byu,{user:{get:function(){return readCookie("wabs")}}}),Object.defineProperties(byu.auth,{accessToken:{get:function(){return cookieProperty("accessToken")}},expires:{get:function(){return cookieProperty("expires",toDate)}}}),byu.auth.login=function(success,options){options||(options={}),"object"==typeof success&&(options=success),options.popup&&(options.failure=reservedPath+"/auto-close",options.success=reservedPath+"/auto-close"),options.success||(options.success=win.location.href),options.failure||(options.failure=options.success),dispatch(EVENT_STATE_CHANGE,getBrowserOauthState("authenticating"));var location=reservedPath+"/login?success="+encodeURIComponent(options.success)+"&failure="+encodeURIComponent(options.failure);options.popup?authPopup(location,"login",{width:800,height:700}):win.location=location},byu.auth.logout=function(redirect,options){var a=arguments,qs="";"object"==typeof a[0]&&(options=a[0],redirect=""),redirect||(redirect=win.location.href);var location=reservedPath+"/logout";options||(options={}),["cas","cFramework","wso2"].forEach(function(key){options.popup&&"cFramework"===key||options&&!1===options[key]||(qs+="&"+key)}),options.popup?authPopup(location+"?redirect="+encodeURIComponent(reservedPath+"/auto-close")+qs,"logout"):win.location=location+"?redirect="+encodeURIComponent(redirect)+qs},byu.auth.proxy=function(options,callback){return ajax({method:"POST",url:reservedPath+"/proxy",body:requestOptions(options)},callback)},byu.auth.refreshToken=function(callback){dispatch(EVENT_STATE_CHANGE,getBrowserOauthState("refreshing"));var promise=ajax(reservedPath+"/refresh-tokens").then(function(data){var body=data.body,status=data.status;return dispatch(EVENT_STATE_CHANGE,400<=status?{state:"error",error:Error(body)}:getBrowserOauthState("authenticated")),data});if(!callback)return promise;promise.then(function(data){callback(data.body,data.status)}).catch(function(err){console.error(err.stack)})},byu.auth.request=function(options,callback){var accessToken=byu.auth.accessToken;if(!accessToken)throw Error("User must be authenticated to make a request.");(options=Object.assign({},options)).headers||(options.headers={}),options.headers.authorization="Bearer "+accessToken;var promise=ajax(options).then(function(data){var body=data.body,code=data.status;return 401===code&&"string"==typeof body&&-1!==body.indexOf("<ams:code>900901</ams:code>")?byu.auth.refreshToken().then(function(){var accessToken=byu.auth.accessToken;return accessToken?(options.headers.authorization="Bearer "+accessToken,ajax(options)):callback(body,code)}):data});if(!callback)return promise;promise.then(function(data){callback(data.body,data.status)}).catch(function(err){console.error(err.stack)})},byu.auth.sync=function(callback){authPopup(reservedPath+"/login?success="+encodeURIComponent(reservedPath+"/auto-close")+"&failure="+encodeURIComponent(reservedPath+"/logout?cas&wso2&redirect="+reservedPath+"/auto-close")+"&gateway=true","sync",{},callback)},byu.navigateTo=function(url,target,callback){var a=arguments;target||(target="_self"),"function"==typeof a[1]&&(callback=a[1],target="_self"),"function"!=typeof callback&&(callback=function(){});var form=doc.createElement("form");if(form.setAttribute("method","POST"),form.style.display="none",form.setAttribute("target",target),form.setAttribute("action",url),doc.body.appendChild(form),!byu.brownie||"object"!=typeof byu.brownie&&0===Object.keys(byu.brownie).length)return submit();var input=createFormInput("brownie",originalBrownie&&originalBrownie.__brownie||"");if(form.appendChild(input),form.appendChild(createFormInput("__notCFramework","true")),!brownieEncodeNeeded())return submit();var loader=doc.createElement("div");function submit(){callback(null),form.submit()}loader.style.cssText="display: block; position: fixed; top: 0; bottom: 0; left: 0; right: 0; background-color: #FFF; opacity: 0; cursor: wait; transition: opacity 300ms",doc.body.appendChild(loader),setTimeout(function(){loader.style.opacity=".5"}),byu.ajax({method:"POST",url:reservedPath+"/brownie-encode",body:byu.brownie},function(body,code){loader.style.opacity="1",setTimeout(function(){doc.body.removeChild(loader)},300),200===code?(input.value=body,submit()):callback(Error("Unexpected response: ["+code+"] "+body))})},function(){var data=parseJson(session.getItem("wabs"));if(data&&data.store){var user=byu.user,brownie=data.store,currentPersonId=user?user.personId:"";byu.brownie=brownie.personId&&currentPersonId!==brownie.personId?{}:brownie,originalBrownie=Object.assign({},byu.brownie),storageUpdate()}prevAuthState.user=!!byu.user,prevAuthState.auth=byu.auth.accessToken}(),doc.addEventListener("click",function(e){var el=e.target||e.srcElement;if(el&&"A"===el.tagName){var href=el.getAttribute("href"),target=el.getAttribute("target")||"_self";(isCFrameworkRx.test(href)||"_self"!==target)&&(e.preventDefault(),byu.navigateTo(href,target))}}),doc.addEventListener("byu-browser-oauth-login-requested",function(){byu.auth.login()}),doc.addEventListener("byu-browser-oauth-logout-requested",function(){return byu.auth.logout()}),doc.addEventListener("byu-browser-oauth-refresh-requested",function(){return byu.auth.refreshToken()}),doc.addEventListener("byu-browser-oauth-current-info-requested",function(e){e.detail.callback(getBrowserOauthState(byu.user?"authenticated":"unauthenticated"))}),win.addEventListener("beforeunload",storageUpdate),updateTimeouts(),setInterval(function(){if(doc.cookie!==prevCookieString){prevCookieString=doc.cookie,checkAuthChange();var user=byu.user,oauth=readCookie(authCookieName,!0);(!user&&oauth||user&&!oauth||oauth&&oauth.personId!==user.personId)&&byu.auth.sync()}},1e3)}function ajax(options,callback){options=requestOptions(options);var xhr=new XMLHttpRequest,promise=new Promise(function(resolve){xhr.onreadystatechange=function(){if(4===xhr.readyState){var body="json"===xhr.responseType?parseJson(xhr.responseText):xhr.responseText;resolve({body:body,status:xhr.status})}},xhr.open(options.method,options.url),Object.keys(options.headers).forEach(function(name){xhr.setRequestHeader(name,options.headers[name])}),xhr.send(options.hasOwnProperty("body")?options.body:null)});return callback?(promise.then(function(data){callback(data.body,data.status)}).catch(function(err){console.error(err.stack)}),xhr):promise}function authPopup(url,name,options,callback){options||(options={}),options.width||(options.width=300),options.height||(options.height=300);var popup=win.open(url,"wabs-popup-"+name+"-"+appName,"menubar=no,location=no,resizable=no,scrollbars=no,status=no,width="+options.width+",height="+options.height);return popup.addEventListener("auto-close",function(){updateTimeouts(),checkAuthChange(callback);try{popup.close()}catch(e){}})}function brownieEncodeNeeded(){return byu.brownie&&"object"==typeof byu.brownie&&0<Object.keys(byu.brownie).length&&JSON.stringify(originalBrownie)!==JSON.stringify(byu.brownie)}function createFormInput(name,value){var input=doc.createElement("input");return input.setAttribute("name",name),input.setAttribute("value",value),input}function checkAuthChange(callback){var user=byu.user,personId=user&&user.personId,accessToken=byu.auth.accessToken,userChanged=personId!==prevAuthState.user,accessTokenChanged=accessToken!==prevAuthState.oauth;prevAuthState.oauth=accessToken,prevAuthState.user=personId,callback&&callback(user,accessToken),userChanged&&(user?dispatch("auth-login",user):dispatch("auth-logout")),accessTokenChanged&&dispatch("access-token-update",accessToken)}function cookieProperty(key,transform){var data=readCookie(authCookieName,!0);if(data)return transform?transform(data[key]):data[key]}function dispatch(name,data){name="wabs-"+name,doc.dispatchEvent(new CustomEvent(name,{detail:data})),doc.dispatchEvent(new CustomEvent("wabs",{detail:{name:name,data:data}}))}function getBrowserOauthState(state){var user=byu.user;if(user){var accessToken=byu.auth.accessToken;return{state:state,token:{bearer:accessToken,authorizationHeader:"Bearer "+accessToken,expiresAt:byu.auth.expires,rawUserInfo:user},user:{personId:user.personId,byuId:user.byuId,netId:user.netId,name:{sortName:user.sortName,displayName:"F"===user.surnamePosition?user.surname+" "+user.preferredFirstName:user.preferredFirstName+" "+user.surname,givenName:user.preferredFirstName,familyName:user.surname,familyNamePosition:user.surnamePosition},rawUserInfo:user}}}return{state:state}}function parseJson(str){try{return JSON.parse(str)}catch(e){return null}}function readCookie(name,signed){var i,cookie,cookieArray=doc.cookie.split(/; */),length=cookieArray.length,value=null;for(name+="=",i=0;i<length;i++)0===(cookie=cookieArray[i]).indexOf(name)&&(value=decodeURIComponent(cookie.substring(name.length,cookie.length)),signed&&(value=value.substring(2,value.lastIndexOf("."))),value=parseJson(value));return value}function requestOptions(options){var config="string"==typeof options?{url:options}:Object.assign({},options);if("string"!=typeof config.url)throw Error("Missing required property: url");config.method||(config.method="GET"),config.method=config.method.toUpperCase();var headers={};return config.headers||(config.headers={}),Object.keys(config.headers).forEach(function(name){headers[name.toLowerCase()]=config.headers[name]}),config.headers=headers,config.body&&"object"==typeof config.body&&(config.headers["content-type"]||(config.headers["content-type"]="application/json"),config.body=JSON.stringify(config.body)),config}function storageUpdate(){var user=byu.user,data={__brownie:originalBrownie&&originalBrownie.__brownie,brownie:byu.brownie,encodeNeeded:brownieEncodeNeeded(),personId:user?user.personId:""};session.setItem("wabs",JSON.stringify(data))}function toDate(value){return new Date(value)}function updateTimeouts(){clearTimeout(accessTokenTimeoutId);var expires=cookieProperty("expires",toDate);expires&&(accessTokenTimeoutId=setTimeout(byu.auth.refreshToken,+expires-Date.now()))}}(appName,reservedPath);